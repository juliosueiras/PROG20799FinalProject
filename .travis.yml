language: ruby
before_install: 
  - gem install ceedling
  - apt-get install pyenv
  - eval "$(pyenv init -)"
  - pyenv install 2.7.6
  - pyenv global 2.7.6
  - pyenv rehash
  - pip install cpp-coveralls
  - pyenv rehash
install:
    - mkdir build
    - cd ${TRAVIS_BUILD_DIR}
      # install latest LCOV (1.9 was failing for me) [1]
    - wget http://ftp.de.debian.org/debian/pool/main/l/lcov/lcov_1.11.orig.tar.gz
    - tar xf lcov_1.11.orig.tar.gz
    - sudo make -C lcov-1.11/ install
      # install lcov to coveralls conversion + upload tool
    - bundler install

before_script: 
    - cd ${TRAVIS_BUILD_DIR}
    - lcov --directory . --zerocounters
script:
    - bundler exec rake 
    - bundler exec rake test:all
    - bundler exec rake gcov:all
after_success:
    - cd ${TRAVIS_BUILD_DIR}
    - lcov --directory . --capture --output-file coverage.info # capture coverage info
    - lcov --remove coverage.info 'tests/*' '/usr/*' 'vendor/*' 'runners/*' --output-file coverage.info # filter out system and test code
    - lcov --list coverage.info # debug before upload
    - coveralls-lcov --repo-token cSyrGD6U5XTmHVzf5QngrzBsSRvdeKDGX coverage.info # uploads to coveralls


